# =============================================================================
# prod9 MAISI Stage 3 Configuration (BraTS)
# ControlNet conditional generation
# =============================================================================

vae_path: "outputs/maisi_vae_final.pt"
diffusion_path: "outputs/maisi_stage2/best.ckpt"
output_dir: "outputs/maisi_stage3"

# =============================================================================
# Model Architecture
# =============================================================================
model:
  controlnet:
    spatial_dims: 3
    in_channels: 16
    condition_dim: 4
    num_channels: [64, 128, 128, 256]
    attention_levels: [False, False, False, True]
    num_res_blocks: [2, 2, 2, 2]
    norm_num_groups: 32

# =============================================================================
# ControlNet Configuration
# =============================================================================
controlnet:
  condition_type: "mask"  # Options: mask, image, label, both
  source_modality: "T1"
  target_modality: "T2"

# =============================================================================
# Training Configuration
# =============================================================================
training:
  optimizer:
    lr_g: 1e-4
    b1: 0.9
    b2: 0.999
    weight_decay: 1e-5

# =============================================================================
# Scheduler Configuration (Rectified Flow)
# =============================================================================
scheduler:
  num_train_timesteps: 1000
  num_inference_steps: 10

# =============================================================================
# Data Configuration (BraTS only - requires segmentation)
# =============================================================================
data:
  data_dir: "${BRATS_DATA_DIR:data/BraTS}"
  batch_size: 1
  num_workers: 4
  roi_size: [64, 64, 64]
  train_val_split: 0.8

  preprocessing:
    spacing: [1.0, 1.0, 1.0]
    orientation: "RAS"
    intensity_a_min: 0.0
    intensity_a_max: 500.0
    intensity_b_min: -1.0
    intensity_b_max: 1.0
    clip: true

# =============================================================================
# Callbacks Configuration
# =============================================================================
callbacks:
  checkpoint:
    monitor: "val/lpips"
    mode: "min"
    save_top_k: 3
    save_last: true

  early_stop:
    enabled: true
    monitor: "val/lpips"
    patience: 15
    mode: "min"

  lr_monitor: true

  # PyTorch Profiler (disabled by default)
  profiler:
    enabled: false
    profile_cpu: true
    profile_cuda: true
    record_shapes: true
    with_stack: true
    profile_memory: true
    trace_dir: "profiler"

# =============================================================================
# Trainer Configuration
# =============================================================================
trainer:
  max_epochs: 30

  hardware:
    accelerator: "auto"
    devices: "auto"
    precision: "bf16-mixed"

  logging:
    log_every_n_steps: 10
    val_check_interval: 1.0
    limit_val_batches: 3

# =============================================================================
# Sliding Window Inference
# =============================================================================
sliding_window:
  enabled: true
  roi_size: [64, 64, 64]
  overlap: 0.5
  sw_batch_size: 1
  mode: "gaussian"
