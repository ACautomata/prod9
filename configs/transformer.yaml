# Transformer Stage 2 Configuration
# Training configuration for MaskGiT transformer

# Path to trained Stage 1 autoencoder
autoencoder_path: "outputs/autoencoder_final.pt"

# Output directory for checkpoints and logs
output_dir: "outputs/stage2"

# Model configuration
model:
  # Latent dimensions from Stage 1 autoencoder
  latent_shape: [4, 4, 4]  # [H, W, D] of latent grid

  # Vocabulary size (product of FSQ levels)
  vocab_size: 512  # 8^3 = 512

  # Transformer dimension
  hidden_dim: 512

  # Number of attention heads
  num_heads: 8

  # Number of transformer layers
  num_layers: 12

  # Feedforward dimension
  ffn_dim: 2048

  # Dropout rate
  dropout: 0.1

  # Number of modalities (T1, T1ce, T2, FLAIR)
  num_modalities: 4

# Training configuration
training:
  # Learning rate
  learning_rate: 1e-4

  # AdamW optimizer beta1
  beta1: 0.9

  # AdamW optimizer beta2
  beta2: 0.999

  # Weight decay
  weight_decay: 0.01

  # Gradient clipping value (0 to disable)
  grad_clip: 1.0

  # Number of training epochs
  max_epochs: 50

# MaskGiT sampler configuration
sampler:
  # Number of sampling steps
  num_steps: 12

  # Mask token value
  mask_value: -100

  # Scheduler type: 'log2', 'linear', or 'sqrt'
  scheduler_type: log2

  # Temperature for sampling (lower = more deterministic)
  temperature: 1.0

# Sliding window configuration (for autoencoder during generation)
sliding_window:
  # ROI size for sliding window inference
  # Should be <= training roi_size to match training distribution
  roi_size: [64, 64, 64]

  # Overlap between adjacent windows (0-1)
  overlap: 0.5

  # Number of windows to process simultaneously
  sw_batch_size: 1

  # Blending mode: 'gaussian', 'constant', or 'mean'
  mode: gaussian

# Data configuration
data:
  # Path to BraTS dataset (use BRATS_DATA_DIR env var, default: data/BraTS)
  data_dir: "${BRATS_DATA_DIR:data/BraTS}"

  # Batch size (adjust based on GPU memory)
  batch_size: 2

  # Number of data loader workers
  num_workers: 4

  # Cache rate for MONAI cache (0-1)
  cache_rate: 0.5

  # ROI size for training crops
  roi_size: [128, 128, 128]

  # Train/validation split ratio
  train_val_split: 0.8

# Loss configuration
loss:
  # Cross-entropy loss weight
  lambda_ce: 1.0

# Callbacks configuration
callbacks:
  # Model checkpoint
  checkpoint:
    monitor: "val/loss"
    mode: "min"
    save_top_k: 3

  # Early stopping
  early_stop:
    monitor: "val/loss"
    patience: 10
    mode: "min"

  # Learning rate monitor
  lr_monitor: true

# Trainer configuration
trainer:
  # Accelerator: 'gpu', 'cpu', 'mps' (Apple Silicon)
  accelerator: "mps"

  # Devices to use
  devices: 1

  # Precision: 32, 16, or bf16
  precision: 32

  # Number of validation batches to log
  limit_val_batches: 5

  # Log every N training batches
  log_every_n_steps: 10
